<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        video {
            width: 320px;
            height: 240px;
            background: #000;
            border-radius: 8px;
            margin: 10px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Video Call System Test</h1>
        <p>This page tests the video call functionality to help diagnose issues.</p>
        
        <div id="status" class="status info">Click "Test Camera & Microphone" to start</div>
        
        <div>
            <button onclick="testPermissions()">üîç Check Permissions</button>
            <button onclick="testCamera()">üìπ Test Camera & Microphone</button>
            <button onclick="stopCamera()" disabled id="stopBtn">‚èπÔ∏è Stop Camera</button>
        </div>
        
        <div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        
        <div id="details" style="margin-top: 20px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        let localStream = null;
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateDetails(info) {
            document.getElementById('details').innerHTML = info;
        }
        
        async function checkPermissions() {
            try {
                if (!navigator.permissions) {
                    return { camera: 'unknown', microphone: 'unknown' };
                }
                
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                const microphonePermission = await navigator.permissions.query({ name: 'microphone' });
                
                return {
                    camera: cameraPermission.state,
                    microphone: microphonePermission.state
                };
            } catch (err) {
                return { camera: 'unknown', microphone: 'unknown' };
            }
        }
        
        function checkBrowserCompatibility() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isChrome = userAgent.includes('chrome') && !userAgent.includes('edge');
            const isFirefox = userAgent.includes('firefox');
            const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
            const isEdge = userAgent.includes('edge');
            
            const isSecure = window.location.protocol === 'https:' || 
                             window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1';
            
            return {
                isSupported: (isChrome || isFirefox || isSafari || isEdge) && isSecure,
                isSecure,
                browser: isChrome ? 'Chrome' : isFirefox ? 'Firefox' : isSafari ? 'Safari' : isEdge ? 'Edge' : 'Unknown',
                hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
            };
        }
        
        async function testPermissions() {
            updateStatus('Checking permissions...', 'info');
            
            const permissions = await checkPermissions();
            const browserCheck = checkBrowserCompatibility();
            
            let details = `<h3>System Information:</h3>`;
            details += `<p><strong>Browser:</strong> ${browserCheck.browser} ${browserCheck.isSupported ? '‚úÖ' : '‚ùå'}</p>`;
            details += `<p><strong>Secure Connection:</strong> ${browserCheck.isSecure ? 'Yes ‚úÖ' : 'No ‚ùå'}</p>`;
            details += `<p><strong>getUserMedia Support:</strong> ${browserCheck.hasGetUserMedia ? 'Yes ‚úÖ' : 'No ‚ùå'}</p>`;
            details += `<p><strong>Camera Permission:</strong> ${permissions.camera} ${permissions.camera === 'granted' ? '‚úÖ' : permissions.camera === 'denied' ? '‚ùå' : '‚ö†Ô∏è'}</p>`;
            details += `<p><strong>Microphone Permission:</strong> ${permissions.microphone} ${permissions.microphone === 'granted' ? '‚úÖ' : permissions.microphone === 'denied' ? '‚ùå' : '‚ö†Ô∏è'}</p>`;
            
            updateDetails(details);
            
            if (!browserCheck.isSupported) {
                updateStatus('‚ùå Browser or connection not supported for video calls', 'error');
            } else if (permissions.camera === 'denied' || permissions.microphone === 'denied') {
                updateStatus('‚ùå Camera or microphone access denied', 'error');
            } else if (permissions.camera === 'granted' && permissions.microphone === 'granted') {
                updateStatus('‚úÖ All permissions granted - ready for video calls!', 'success');
            } else {
                updateStatus('‚ö†Ô∏è Permissions not yet requested - will ask when testing camera', 'info');
            }
        }
        
        async function testCamera() {
            updateStatus('Requesting camera and microphone access...', 'info');
            
            const constraints = [
                { video: true, audio: true },
                { video: true, audio: false },
                { video: { width: 640, height: 480 }, audio: true },
                { video: { width: 320, height: 240 }, audio: false }
            ];
            
            for (let i = 0; i < constraints.length; i++) {
                try {
                    console.log(`Trying constraint ${i + 1}:`, constraints[i]);
                    
                    localStream = await Promise.race([
                        navigator.mediaDevices.getUserMedia(constraints[i]),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout after 10 seconds')), 10000)
                        )
                    ]);
                    
                    // Success!
                    const videoEl = document.getElementById('localVideo');
                    videoEl.srcObject = localStream;
                    
                    document.getElementById('stopBtn').disabled = false;
                    
                    let details = `<h3>Camera Test Results:</h3>`;
                    details += `<p><strong>Constraint Used:</strong> ${i + 1}</p>`;
                    details += `<p><strong>Video Tracks:</strong> ${localStream.getVideoTracks().length}</p>`;
                    details += `<p><strong>Audio Tracks:</strong> ${localStream.getAudioTracks().length}</p>`;
                    
                    if (localStream.getVideoTracks().length > 0) {
                        const videoTrack = localStream.getVideoTracks()[0];
                        const settings = videoTrack.getSettings();
                        details += `<p><strong>Video Resolution:</strong> ${settings.width}x${settings.height}</p>`;
                        details += `<p><strong>Frame Rate:</strong> ${settings.frameRate}</p>`;
                    }
                    
                    updateDetails(details);
                    updateStatus('‚úÖ Camera and microphone working perfectly!', 'success');
                    return;
                    
                } catch (err) {
                    console.log(`Constraint ${i + 1} failed:`, err.name, err.message);
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        updateStatus('‚ùå Permission denied - please allow camera and microphone access', 'error');
                        updateDetails(`<p><strong>Error:</strong> ${err.message}</p><p>Please click the camera icon in your browser's address bar and allow permissions.</p>`);
                        return;
                    }
                    
                    if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        if (i >= 1) {
                            updateStatus('‚ùå No camera or microphone found', 'error');
                            updateDetails(`<p><strong>Error:</strong> ${err.message}</p><p>Please connect a webcam and microphone.</p>`);
                            return;
                        }
                    }
                    
                    if (i === constraints.length - 1) {
                        updateStatus(`‚ùå Camera test failed: ${err.message}`, 'error');
                        updateDetails(`<p><strong>Error:</strong> ${err.message}</p>`);
                    }
                }
            }
        }
        
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('stopBtn').disabled = true;
                updateStatus('Camera stopped', 'info');
            }
        }
        
        // Auto-check on page load
        window.addEventListener('load', testPermissions);
    </script>
</body>
</html>